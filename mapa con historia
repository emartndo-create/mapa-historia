<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu칤a Hist칩rica Pro: Modo 칄poca</title>
    <style>
        :root { --cafe: #2c1e14; --oro: #c5a059; --fondo: #f4f1ea; --texto: #333; }
        .dark-mode { --cafe: #1a1a1a; --oro: #d4af37; --fondo: #2c2c2c; --texto: #eee; }

        body { font-family: 'Georgia', serif; margin: 0; background: var(--fondo); display: flex; flex-direction: column; height: 100vh; transition: background 0.5s; overflow: hidden; }
        #map { flex-grow: 1; width: 100%; transition: filter 0.5s; }
        
        /* Controles Superiores */
        .top-ui { position: absolute; top: 10px; left: 10px; z-index: 100; display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* Panel IA Narradora */
        #panel-ia { background: var(--cafe); color: white; padding: 20px; z-index: 10; max-height: 45vh; overflow-y: auto; transition: background 0.5s; }
        .contenedor-info { max-width: 800px; margin: 0 auto; text-align: center; }
        
        .btn { background: var(--oro); border: none; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; margin: 5px; color: var(--cafe); transition: 0.3s; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        
        #more-info { display: none; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; }
        .galeria-fotos { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; }
        .galeria-fotos img { height: 110px; border-radius: 8px; cursor: pointer; border: 2px solid var(--oro); }

        input[type=range] { width: 100%; margin-top: 15px; accent-color: var(--oro); }
    </style>
</head>
<body>

    <div class="top-ui">
        <button class="btn" onclick="toggleNocturno()">游깿 Modo Nocturno</button>
        <select id="voice-select" style="padding: 8px; border-radius: 5px;"></select>
        <div id="google_translate_element"></div>
    </div>

    <div id="map"></div>

    <div id="panel-ia">
        <div class="contenedor-info">
            <h2 id="display-titulo" style="margin: 0; color: var(--oro);">Bienvenido Cronista</h2>
            <p id="display-corta">Deslice para iniciar el relato hist칩rico...</p>
            
            <button id="btn-expandir" class="btn" style="display:none;" onclick="toggleHistoria()">游닆 Saber m치s</button>
            <button class="btn" onclick="narrarActual()">游댉 Narraci칩n Solemne</button>

            <div id="more-info">
                <p id="texto-completo" style="line-height: 1.6;"></p>
                <div id="galeria-contenedor" class="galeria-fotos"></div>
            </div>

            <input type="range" id="timeline" min="1800" max="1900" value="1800">
            <div style="font-size: 1.2em; margin-top: 5px;">A침o Destacado: <strong id="year-label">1800</strong></div>
        </div>
    </div>

    <script>
        let map, historyData = [], markers = [], currentPoint = null, esNocturno = false;
        let synth = window.speechSynthesis, voces = [];

        // Estilos de mapa
        const estiloClaro = []; 
        const estiloNocturno = [
            { "elementType": "geometry", "stylers": [{ "color": "#242f3e" }] },
            { "elementType": "labels.text.fill", "stylers": [{ "color": "#746855" }] },
            { "featureType": "water", "stylers": [{ "color": "#17263c" }] }
        ];

        async function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16, center: { lat: -34.6037, lng: -58.3816 },
                disableDefaultUI: true // Mapa m치s limpio
            });

            const res = await fetch('puntos.json');
            historyData = await res.json();
            
            document.getElementById('timeline').oninput = function() {
                const year = parseInt(this.value);
                document.getElementById('year-label').innerText = year;
                actualizarMapa(year);
            };

            cargarVoces();
        }

        function actualizarMapa(anio) {
            const activos = historyData.filter(p => p.anio <= anio);
            markers.forEach(m => m.setMap(null));
            markers = [];

            if (activos.length > 0) {
                currentPoint = activos[activos.length - 1];
                document.getElementById('display-titulo').innerText = currentPoint.titulo;
                document.getElementById('display-corta').innerText = currentPoint.resena_corta;
                document.getElementById('btn-expandir').style.display = 'inline-block';
                document.getElementById('more-info').style.display = 'none';
                
                const pos = { lat: currentPoint.lat, lng: currentPoint.lng };
                const marker = new google.maps.Marker({ position: pos, map: map, icon: 'http://maps.google.com/mapfiles/ms/icons/gold-marker.png' });
                markers.push(marker);
                map.panTo(pos);
            }
        }

        function toggleHistoria() {
            const panel = document.getElementById('more-info');
            if (panel.style.display === 'none') {
                document.getElementById('texto-completo').innerText = currentPoint.historia_completa;
                document.getElementById('galeria-contenedor').innerHTML = 
                    currentPoint.galeria.map(img => <img src="${img}" onclick="window.open('${img}')">).join('');
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function toggleNocturno() {
            esNocturno = !esNocturno;
            document.body.classList.toggle('dark-mode');
            map.setOptions({ styles: esNocturno ? estiloNocturno : estiloClaro });
        }

        function cargarVoces() {
            voces = synth.getVoices();
            const selector = document.getElementById('voice-select');
            selector.innerHTML = voces.map((v, i) => <option value="${i}" ${v.lang.includes('es') ? 'selected' : ''}>${v.name}</option>).join('');
        }
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = cargarVoces;

        function narrarActual() {
            if (!currentPoint) return;
            synth.cancel();
            const esExtendido = document.getElementById('more-info').style.display === 'block';
            const msg = new SpeechSynthesisUtterance(esExtendido ? currentPoint.historia_completa : currentPoint.resena_corta);
            msg.voice = voces[document.getElementById('voice-select').value];
            msg.pitch = 0.8; msg.rate = 0.85;
            synth.speak(msg);
        }

        function googleTranslateElementInit() {
            new google.translate.TranslateElement({pageLanguage: 'es'}, 'google_translate_element');
        }
    </script>
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap"></script>
</body>
</html>
